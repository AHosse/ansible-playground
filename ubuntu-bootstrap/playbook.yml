#!/usr/bin/env ansible-playbook
---
- hosts: local
  gather_facts: yes
  vars: 
    user: s.kupstaitis-dunkler
    workspace_path: ~/workspace/private/
    deploy_bashrc: no
    deploy_vimrc: no
    chefdk_deb_url: https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/12.04/x86_64/chefdk_0.11.2-1_amd64.deb
    chefdk_deb_filename: /tmp/chefdk.deb
    powerline_fonts_git: https://github.com/powerline/fonts.git
    powerline_fonts_url: https://github.com/powerline/powerline/raw/develop/font/PowerlineSymbols.otf
    powerline_fonts_config_url: https://github.com/powerline/powerline/raw/develop/font/10-powerline-symbols.conf
    vundle_url: https://github.com/VundleVim/Vundle.vim.git
    packages_to_install: [
        git, git-flow, gitk, ansible, automake, build-essential, 
        chromium-browser, docker.io, ipython, mosh, nodejs-legacy,
        npm, openjdk-7-jdk, python-pip, ruby2.0-dev, python-dev,
        vagrant, terminator, vim, cowsay, htop, bc, ranger, ngrep,
        dtrx, dstat, libfreetype6-dev, libblas3, gfortran,
        liblapack3, libblas-dev, liblapack-dev, libatlas-base-dev,
        freeipa-client, sysstat, libsasl2-dev, virtualbox, krb5-user ]
    pip_packages_to_install: [
        awscli, jupyter, matplotlib, flake8, nose, vim_bridge, mock,
        numpy, scipy, pandas, scikit-learn, scikit-image,
        "snakebite[kerberos]", fabric, virtualenv ]
    ruby_gems_to_install: [ kitchen-docker ]
  sudo: yes
  tasks:
    - name: install ubuntu packages
      apt: pkg={{ item }} state=installed
      with_items: packages_to_install

    - name: install python modules with pip
      pip: name={{ item }}
      with_items: pip_packages_to_install
   
    - name: install Vundle
      git: repo='{{ vundle_url }}' dest='~/.vim/bundle/Vundle.vim'

    - name: install Vundle plugins
      command: "vim -E -s -c 'source ~/.vimrc' -c PluginInstall -c qa"
      register: vundle_install
      failed_when: vundle_install.rc > 1
      changed_when: vundle_install.rc == 1

    - name: install node.js packages with npm
      npm: name={{ item }} global=yes
      with_items:
        - azure-cli

    - name: deploy bashrc file
      template: src=./templates/.bashrc.j2 dest=/home/{{ user }}/.bashrc owner={{ user }} group={{ user }}
      when: deploy_bashrc
      
    - name: deploy vimrc file
      copy: src=./files/.vimrc dest=/home/{{ user }}/.vimrc owner={{ user }} group={{ user }}
      when: deploy_vimrc
      
    - name: deploy ssh config file
      copy: src=./files/ssh_config dest=/home/{{ user }}/.ssh/config owner={{ user }} group={{ user }}

    - name: download powerline fonts from git
      git: repo='{{ powerline_fonts_git }}' dest='{{ workspace_path }}/fonts'
      notify:
        - install powerline fonts

    - name: download powerline fonts from url
      get_url: url={{ powerline_fonts_url }} dest=/usr/share/fonts/ validate_certs=no
      notify:
        - update font cache

    - name: download powerline fonts config from url
      get_url: url={{ powerline_fonts_config_url }} dest=/etc/fonts/conf.d/ validate_certs=no
      notify:
        - update font cache

    - name: check if chefdk is installed
      command: dpkg-query -W chefdk
      register: is_chefdk_installed
      failed_when: is_chefdk_installed.rc > 1
      changed_when: is_chefdk_installed.rc == 1
      notify:
        - download chefdk

    - name: use ruby2.0 per default
      file: path=/usr/bin/ruby src=/usr/bin/ruby2.0 state=link
      
    - name: use gem2.0 per default
      file: path=/usr/bin/gem src=/usr/bin/gem2.0 state=link

    - name: install ruby gems
      gem: name={{ item  }} state=latest
      with_items: ruby_gems_to_install

  handlers:
    - name: install powerline fonts
      command: "{{ workspace_path }}/fonts/install.sh"

    - name: download chefdk
      command: "wget '{{ chefdk_deb_url }}' -o {{ chefdk_deb_filename }}"
      notify:
        - install chefdk
    
    - name: install chefdk
      apt: deb="{{ chefdk_deb_filename }}"

    - name: update font cache
      command: fc-cache -vf /usr/share/fonts  

